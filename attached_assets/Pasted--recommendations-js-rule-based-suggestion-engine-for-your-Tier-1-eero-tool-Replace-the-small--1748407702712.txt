// recommendations.js – rule‑based suggestion engine for your Tier‑1 eero tool
// Replace the small demo from v1 with this richer rule set.
// -----------------------------------------------------------------------------
// 𝐈𝐍𝐏𝐔𝐓 – build a `selections` object as the agent/customer answers the wizard.
// Example:
//   const selections = {
//     connectionType: 'wifi',     // 'wifi' | 'wired'
//     band: '5',                  // '2.4' | '5' | '6'
//     speedBucket: 'sub100',      // 'sub50' | 'sub100' | 'sub300' | 'good'
//     rssi: 'low',                // 'low' | 'good'
//     ethernetLink: '100',        // '100' | '1000' | '2500' | '10000'
//     ssidChanged: true,          // network name recently changed
//     newEero: true,              // node added in last 24 h
//     deviceBandCap: '2.4_only',  // '2.4_only' | 'dual' | '6e'
//     dfsHits: true,              // DFS radar events present
//     event: 'deviceFlapping'     // key Event‑Stream flag if any
//   };
// -----------------------------------------------------------------------------
// 𝐎𝐔𝐓𝐏𝐔𝐓 – call `getRecommendations(selections)` to receive an array of plain‑
// text fixes ready to render.
// -----------------------------------------------------------------------------

const rules = [
  // ───────────────────────── Wi‑Fi signal / RSSI ────────────────────────────
  {
    when: { connectionType: 'wifi', rssi: 'low' },
    solutions: [
      'Have the customer move the device closer to the nearest eero.',
      'Relocate an eero or add another node midway to boost mesh coverage.',
      'Remove metal/mirrored obstacles that can attenuate 5–6 GHz signal.'
    ]
  },

  // ───────────────────── Gateway link negotiating at 100 Mbps ───────────────
  {
    when: { ethernetLink: '100' },
    solutions: [
      'Swap the Ethernet patch cord between ONT and gateway (should click firmly).',
      'Verify the upstream port or media converter actually supports ≥1 Gbps.',
      'Inspect the cable run for water ingress, kinks, or bent pins.'
    ]
  },

  // ───────────────────── Repeated gateway‑offline events ────────────────────
  {
    when: { event: 'gatewayOffline' },
    solutions: [
      'Power‑cycle the gateway eero and ONT in proper order (ONT first).',
      'Check the power outlet / UPS; brown‑outs can cause random reboots.',
      'Try a different eero power adapter to rule out PSU faults.'
    ]
  },

  // ───────────────────── DFS radar hits forcing channel switch ──────────────
  {
    when: { dfsHits: true },
    solutions: [
      'Disable DFS channels temporarily in Settings ▶ eero Labs ▶ DFS.',
      'Re‑site the eero away from radar sources (weather radar, airports).',
      'Use channels 36–48 to avoid DFS if near military radars.'
    ]
  },

  // ───────────────────── Network name (SSID) recently changed ───────────────
  {
    when: { ssidChanged: true },
    solutions: [
      'Ask customer to “forget” the old SSID on all devices and reconnect.',
      'Update hard‑coded IoT devices (printers, cameras) with the new SSID.',
      'Reboot devices that tend to cache old SSIDs (e.g., Chromecast/FireTV).' 
    ]
  },

  // ───────────────────── New eero node just installed ───────────────────────
  {
    when: { newEero: true },
    solutions: [
      'Wait 5 min for the new node to finish firmware update before testing.',
      'Make sure the new node is >10 ft from the gateway to avoid RF echo.',
      'If wired back‑haul is unavailable, ensure clear line‑of‑sight to another node.'
    ]
  },

  // ───────────────────── Device limited to 2.4 GHz only ─────────────────────
  {
    when: { deviceBandCap: '2.4_only' },
    solutions: [
      'Enable “Legacy Mode” in the eero app to broadcast a 2.4 GHz‑only SSID.',
      'Reduce channel width from 40 MHz to 20 MHz to minimize interference.',
      'Advise customer that max throughput will cap around 50–70 Mbps on 2.4 GHz.'
    ]
  },

  // ───────────────────── Slow speed on 5 GHz band ───────────────────────────
  {
    when: { band: '5', speedBucket: 'sub100' },
    solutions: [
      'Check for DFS hits; force channel 44/80 MHz where possible.',
      'Verify client NIC supports 802.11ac 80 MHz; update drivers/firmware.',
      'Relocate microwave ovens or cordless phones that sit on 5 GHz channels.'
    ]
  },

  // ───────────────────── Under‑performing Wi‑Fi 6E (6 GHz) ───────────────────
  {
    when: { band: '6', speedBucket: 'sub300' },
    solutions: [
      'Confirm client device actually supports Wi‑Fi 6E and WPA3‑SAE.',
      'Update client OS and Wi‑Fi drivers; early 6E stacks had throughput bugs.',
      'Reduce distance; 6 GHz attenuates faster than 5 GHz—stay within one room.'
    ]
  },

  // ───────────────────── Device flapping (disconnect/reconnect) ──────────────
  {
    when: { event: 'deviceFlapping' },
    solutions: [
      'Turn off “Band Steering” for that device to lock it to a single band.',
      'Assign a static IP or DHCP reservation to rule out lease conflicts.',
      'Update device firmware; older IoT sensors often drop when roaming.'
    ]
  }
];

// -----------------------------------------------------------------------------
// De‑duplicate fixes across multiple matched rules and return them.
export function getRecommendations(selections) {
  return [...new Set(
    rules
      .filter(rule => Object.entries(rule.when).every(([k, v]) => selections[k] === v))
      .flatMap(rule => rule.solutions)
  )];
}

// -----------------------------------------------------------------------------
/* Example usage – remove before production
import { getRecommendations } from './recommendations.js';
const fixes = getRecommendations({
  connectionType: 'wifi',
  rssi: 'low',
  band: '5',
  speedBucket: 'sub100',
  ssidChanged: true
});
console.log(fixes);
*/
