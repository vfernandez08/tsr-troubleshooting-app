{% extends "base.html" %}

{% block content %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Nokia+Pure:wght@400;700&family=Open+Sans:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap');

/* Cool Equipment Buttons with Brand Colors */
.cool-button-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 20px;
}

.cool-equipment-btn {
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid #e9ecef;
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.cool-equipment-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

/* Nokia Branding */
.cool-equipment-btn.nokia-btn {
    border-color: #124191;
}

.cool-equipment-btn.nokia-btn:hover {
    border-color: #124191;
    box-shadow: 0 8px 25px rgba(18,65,145,0.2);
}

.cool-equipment-btn.nokia-btn.active {
    background: linear-gradient(135deg, #124191 0%, #0d2f6b 100%);
    border-color: #124191;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(18,65,145,0.4);
}

.cool-equipment-btn.nokia-btn .btn-icon {
    background: linear-gradient(135deg, #124191 0%, #0d2f6b 100%);
}

.cool-equipment-btn.nokia-btn .btn-content h5 {
    font-family: 'Nokia Pure', 'Arial', sans-serif;
    color: #124191;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.cool-equipment-btn.nokia-btn.active .btn-content h5 {
    color: white;
}

/* Calix Branding - Royal Blue and Orange */
.cool-equipment-btn.calix-btn {
    border-color: #1e3a8a;
    background: linear-gradient(135deg, #f8f9fa 0%, #fff7ed 100%);
}

.cool-equipment-btn.calix-btn:hover {
    border-color: #1e3a8a;
    box-shadow: 0 8px 25px rgba(30,58,138,0.2);
}

.cool-equipment-btn.calix-btn.active {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-color: #1e3a8a;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30,58,138,0.4);
}

.cool-equipment-btn.calix-btn .btn-icon {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
}

.cool-equipment-btn.calix-btn .btn-content h5 {
    font-family: 'Open Sans', sans-serif;
    color: #1e3a8a;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.cool-equipment-btn.calix-btn.active .btn-content h5 {
    color: white;
}

/* DZS Branding - Black, Sky Blue, Teal, Grey, Royal Blue */
.cool-equipment-btn.dzs-btn {
    border-color: #1e40af;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.cool-equipment-btn.dzs-btn:hover {
    border-color: #1e40af;
    box-shadow: 0 8px 25px rgba(30,64,175,0.2);
}

.cool-equipment-btn.dzs-btn.active {
    background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
    border-color: #1e40af;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30,64,175,0.4);
}

.cool-equipment-btn.dzs-btn .btn-icon {
    background: linear-gradient(135deg, #0ea5e9 0%, #0891b2 100%);
}

.cool-equipment-btn.dzs-btn .btn-content h5 {
    font-family: 'Roboto', sans-serif;
    color: #1e40af;
    font-weight: 700;
    font-size: 22px;
    letter-spacing: 2px;
}

.cool-equipment-btn.dzs-btn.active .btn-content h5 {
    color: white;
}

/* Router Buttons */
.cool-equipment-btn.eero-btn {
    border-color: #007bff;
}

.cool-equipment-btn.eero-btn:hover {
    border-color: #007bff;
    box-shadow: 0 8px 25px rgba(0,123,255,0.2);
}

.cool-equipment-btn.eero-btn.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: #007bff;
    color: white;
}

.cool-equipment-btn.eero-btn .btn-icon {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.cool-equipment-btn.eero-btn .btn-content h5 {
    font-family: 'Open Sans', sans-serif;
    color: #007bff;
    font-weight: 600;
}

.cool-equipment-btn.customer-btn {
    border-color: #6c757d;
}

.cool-equipment-btn.customer-btn:hover {
    border-color: #6c757d;
    box-shadow: 0 8px 25px rgba(108,117,125,0.2);
}

.cool-equipment-btn.customer-btn.active {
    background: linear-gradient(135deg, #6c757d 0%, #565e64 100%);
    border-color: #6c757d;
    color: white;
}

.cool-equipment-btn.customer-btn .btn-icon {
    background: linear-gradient(135deg, #6c757d 0%, #565e64 100%);
}

/* Common styles */
.cool-equipment-btn.active .btn-icon i,
.cool-equipment-btn.active .btn-content span,
.cool-equipment-btn.active .btn-arrow i {
    color: white;
}

.cool-equipment-btn.active .btn-icon {
    background: rgba(255,255,255,0.2);
}

.btn-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    flex-shrink: 0;
}

.btn-icon i {
    font-size: 24px;
    color: white;
}

.btn-content {
    flex: 1;
    text-align: left;
}

.btn-content h5 {
    margin: 0 0 4px 0;
    font-weight: 700;
    font-size: 20px;
}

.btn-content span {
    color: #6c757d;
    font-size: 14px;
    font-weight: 500;
}

.btn-arrow {
    margin-left: 16px;
    opacity: 0.6;
    transition: all 0.3s ease;
}

.cool-equipment-btn:hover .btn-arrow {
    opacity: 1;
    transform: translateX(4px);
}

.btn-arrow i {
    font-size: 18px;
    color: inherit;
}
</style>
<div class="container-fluid">
    <!-- Progress Bar -->
    <div class="wizard-progress mb-4">
        <div class="progress-container">
            <div class="step-item {{ 'active' if current_step == 1 else ('completed' if current_step > 1 else '') }}" data-step="1">
                <div class="step-circle">
                    <i class="fas fa-search"></i>
                </div>
                <span class="step-label">Identify ONT</span>
            </div>
            <div class="step-connector {{ 'completed' if current_step > 1 else '' }}"></div>
            
            <div class="step-item {{ 'active' if current_step == 2 else ('completed' if current_step > 2 else '') }}" data-step="2">
                <div class="step-circle">
                    <i class="fas fa-router"></i>
                </div>
                <span class="step-label">Select Router</span>
            </div>
            <div class="step-connector {{ 'completed' if current_step > 2 else '' }}"></div>
            
            <div class="step-item {{ 'active' if current_step == 3 else ('completed' if current_step > 3 else '') }}" data-step="3">
                <div class="step-circle">
                    <i class="fas fa-stethoscope"></i>
                </div>
                <span class="step-label">Run Diagnostics</span>
            </div>
            <div class="step-connector {{ 'completed' if current_step > 3 else '' }}"></div>
            
            <div class="step-item {{ 'active' if current_step == 4 else ('completed' if current_step > 4 else '') }}" data-step="4">
                <div class="step-circle">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <span class="step-label">Log & Report</span>
            </div>
        </div>
    </div>

    <!-- Header with Case Info -->
    <div class="case-header mb-4">
        <h2 class="case-title">
            Case {{ case.case_number }} â€“ In Progress | 
            <span class="step-indicator">Step {{ current_step }} of 4: {{ step_titles[current_step] }}</span>
        </h2>
    </div>

    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            {% if current_step == 1 %}
            <!-- Step 1: Equipment Identification -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Equipment Identification
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="Look for the ONT device (small white/black box) usually mounted on the wall where fiber enters the home. Check the label on the device for the type information.">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('next_step') }}" id="equipmentForm">
                        <script>
                        // Store case ID in localStorage
                        localStorage.setItem('tsr_case_id', '{{ case.id }}');
                        localStorage.setItem('tsr_case_timestamp', Date.now());
                        
                        // Check for session expiry and redirect with case ID
                        function checkSession() {
                            if (window.location.search.indexOf('case_id=') === -1) {
                                const caseId = localStorage.getItem('tsr_case_id');
                                if (caseId) {
                                    window.location.href = window.location.pathname + '?case_id=' + caseId;
                                }
                            }
                        }
                        
                        // Run session check periodically
                        setInterval(checkSession, 1000);
                        
                        // If page shows session error, auto-recover
                        window.addEventListener('load', function() {
                            const alerts = document.querySelectorAll('.alert');
                            alerts.forEach(function(alert) {
                                if (alert.textContent.includes('Session') || alert.textContent.includes('expired')) {
                                    window.location.href = '/recover_session';
                                }
                            });
                        });
                        </script>
                        <input type="hidden" name="current_step" value="1">
                        <input type="hidden" name="case_id" value="{{ case.id }}">
                        
                        <div class="mb-4">
                            <label class="form-label required mb-4">Select ONT Type</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn nokia-btn {{ 'active' if case.ont_type == 'Nokia (Altiplano)' else '' }}" data-value="Nokia (Altiplano)" data-target="ont_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-network-wired"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>NOKIA</h5>
                                        <span>Altiplano ONT</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn calix-btn {{ 'active' if case.ont_type == 'Calix (SMX)' else '' }}" data-value="Calix (SMX)" data-target="ont_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-microchip"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>CALIX</h5>
                                        <span>SMX Series</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn dzs-btn {{ 'active' if case.ont_type == 'DZS' else '' }}" data-value="DZS" data-target="ont_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-server"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>DZS</h5>
                                        <span>ONT Device</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="ont_type" id="ont_type_input" value="{{ case.ont_type or '' }}" required>
                        </div>


                    </form>
                </div>
            </div>

            {% elif current_step == 2 %}
            <!-- Step 2: Router Selection -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-router me-2"></i>
                        Router Selection
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="The router is usually a separate device connected to the ONT. For Eero systems, look for mesh units throughout the home. Check device labels for model information.">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('next_step') }}" id="routerForm">
                        <input type="hidden" name="current_step" value="2">
                        <input type="hidden" name="case_id" value="{{ case.id }}">
                        
                        <div class="mb-4">
                            <label class="form-label required mb-4">Select Router Type</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn eero-btn {{ 'active' if case.router_type == 'Eero' else '' }}" data-value="Eero" data-target="router_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-wifi"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>eero</h5>
                                        <span>Mesh System</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn nokia-btn {{ 'active' if case.router_type == 'Nokia' else '' }}" data-value="Nokia" data-target="router_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-router"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>NOKIA</h5>
                                        <span>Router Device</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn customer-btn {{ 'active' if case.router_type == 'Customer-Owned' else '' }}" data-value="Customer-Owned" data-target="router_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-user-cog"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Customer</h5>
                                        <span>Own Router</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="router_type" id="router_type_input" value="{{ case.router_type or '' }}" required>
                        </div>

                        <div class="wizard-actions">
                            <button type="button" class="btn btn-outline-secondary" onclick="previousStep()">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to ONT Selection
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% elif current_step == 3 %}
            <!-- Step 3: Issue Classification -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Issue Classification
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="Select the primary issue the customer is reporting to determine the correct troubleshooting path.">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('next_step') }}" id="issueForm">
                        <input type="hidden" name="current_step" value="3">
                        <input type="hidden" name="case_id" value="{{ case.id }}">
                        
                        <div class="mb-4">
                            <label class="form-label required">What is the customer reporting?</label>
                            <div class="issue-options">
                                <div class="form-check issue-card mb-3">
                                    <input class="form-check-input" type="radio" name="issue_type" id="harddown" value="No Internet" required>
                                    <label class="form-check-label" for="harddown">
                                        <div class="issue-content">
                                            <h6><i class="fas fa-times-circle text-danger me-2"></i>No Internet (Hard Down)</h6>
                                            <p class="small text-muted mb-0">Customer has no internet connectivity at all</p>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check issue-card mb-3">
                                    <input class="form-check-input" type="radio" name="issue_type" id="slow" value="Slow Speeds" required>
                                    <label class="form-check-label" for="slow">
                                        <div class="issue-content">
                                            <h6><i class="fas fa-tachometer-alt text-warning me-2"></i>Slow Speeds</h6>
                                            <p class="small text-muted mb-0">Internet is working but slower than expected</p>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check issue-card mb-3">
                                    <input class="form-check-input" type="radio" name="issue_type" id="intermittent" value="Intermittent Connection" required>
                                    <label class="form-check-label" for="intermittent">
                                        <div class="issue-content">
                                            <h6><i class="fas fa-wifi text-info me-2"></i>Intermittent Connection</h6>
                                            <p class="small text-muted mb-0">Connection drops out or is unstable</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="issue_description" class="form-label">Additional Details</label>
                            <textarea class="form-control" id="issue_description" name="issue_description" rows="3" 
                                      placeholder="Any additional details about the customer's issue..."></textarea>
                        </div>

                        <div class="wizard-actions">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="previousStep()">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="continueBtn" disabled>
                                <i class="fas fa-arrow-right me-2"></i>
                                Begin Troubleshooting
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% elif current_step == 4 %}
            <!-- Step 4: Log & Report -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Case Summary & Report
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Final report content -->
                    <div class="summary-report">
                        <p>Case summary and dispatch information will be generated here.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Side Panel -->
        <div class="col-lg-4">
            <div class="side-panel">
                <!-- Equipment Information -->
                <div class="info-card">
                    <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#equipmentInfo">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Equipment Information
                            <i class="fas fa-chevron-down float-end"></i>
                        </h6>
                    </div>
                    <div class="collapse show" id="equipmentInfo">
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">ONT Type:</span>
                                    <span class="info-value status-badge {{ 'badge-success' if case.ont_type else 'badge-neutral' }}">
                                        {{ case.ont_type or 'Not selected' }}
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Router Type:</span>
                                    <span class="info-value status-badge {{ 'badge-success' if case.router_type else 'badge-neutral' }}">
                                        {{ case.router_type or 'Not selected' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sticky Footer -->
    <div class="sticky-footer">
        <div class="footer-content">
            <div class="footer-left">
                <span class="text-muted small">
                    <i class="fas fa-save me-1"></i>
                    Auto-saved
                </span>
            </div>
            <div class="footer-right">
                <a href="{{ url_for('case_summary', case_id=case.id) }}" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-eye me-1"></i>
                    View Summary
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-home me-1"></i>
                    Back to Home
                </a>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle cool equipment button clicks - submit immediately
    document.querySelectorAll('.cool-equipment-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const target = this.dataset.target;
            const value = this.dataset.value;
            
            // Remove active class from siblings
            this.parentElement.querySelectorAll('.cool-equipment-btn').forEach(function(sibling) {
                sibling.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update hidden input
            const hiddenInput = document.getElementById(target + '_input');
            if (hiddenInput) {
                hiddenInput.value = value;
            }
            
            // Submit the form immediately
            const form = this.closest('form');
            if (form) {
                form.submit();
            }
        });
    });
});

function previousStep() {
    window.history.back();
}
</script>
{% endblock %}