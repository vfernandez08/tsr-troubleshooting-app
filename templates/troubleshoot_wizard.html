{% extends "base.html" %}

{% block content %}
<style>
@import url('https://fonts.googleapis.com/css2?family=Nokia+Pure:wght@400;700&family=Open+Sans:wght@400;600;700&family=Roboto:wght@400;500;700&display=swap');

/* Cool Equipment Buttons with Brand Colors */
.cool-button-grid {
    display: grid;
    gap: 20px;
    margin-bottom: 20px;
}

.cool-equipment-btn {
    display: flex;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
    border: 2px solid #e9ecef;
    border-radius: 16px;
    padding: 24px;
    transition: all 0.3s ease;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    box-shadow: 0 4px 12px rgba(0,0,0,0.05);
}

.cool-equipment-btn:hover {
    transform: translateY(-4px);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
}

/* Nokia Branding */
.cool-equipment-btn.nokia-btn {
    border-color: #124191;
}

.cool-equipment-btn.nokia-btn:hover {
    border-color: #124191;
    box-shadow: 0 8px 25px rgba(18,65,145,0.2);
}

.cool-equipment-btn.nokia-btn.active {
    background: linear-gradient(135deg, #124191 0%, #0d2f6b 100%);
    border-color: #124191;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(18,65,145,0.4);
}

.cool-equipment-btn.nokia-btn .btn-icon {
    background: linear-gradient(135deg, #124191 0%, #0d2f6b 100%);
}

.cool-equipment-btn.nokia-btn .btn-content h5 {
    font-family: 'Nokia Pure', 'Arial', sans-serif;
    color: #124191;
    font-weight: 700;
    letter-spacing: -0.5px;
}

.cool-equipment-btn.nokia-btn.active .btn-content h5 {
    color: white;
}

/* Calix Branding - Royal Blue and Orange */
.cool-equipment-btn.calix-btn {
    border-color: #1e3a8a;
    background: linear-gradient(135deg, #f8f9fa 0%, #fff7ed 100%);
}

.cool-equipment-btn.calix-btn:hover {
    border-color: #1e3a8a;
    box-shadow: 0 8px 25px rgba(30,58,138,0.2);
}

.cool-equipment-btn.calix-btn.active {
    background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
    border-color: #1e3a8a;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30,58,138,0.4);
}

.cool-equipment-btn.calix-btn .btn-icon {
    background: linear-gradient(135deg, #f97316 0%, #ea580c 100%);
}

.cool-equipment-btn.calix-btn .btn-content h5 {
    font-family: 'Open Sans', sans-serif;
    color: #1e3a8a;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
}

.cool-equipment-btn.calix-btn.active .btn-content h5 {
    color: white;
}

/* DZS Branding - Black, Sky Blue, Teal, Grey, Royal Blue */
.cool-equipment-btn.dzs-btn {
    border-color: #1e40af;
    background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
}

.cool-equipment-btn.dzs-btn:hover {
    border-color: #1e40af;
    box-shadow: 0 8px 25px rgba(30,64,175,0.2);
}

.cool-equipment-btn.dzs-btn.active {
    background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
    border-color: #1e40af;
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(30,64,175,0.4);
}

.cool-equipment-btn.dzs-btn .btn-icon {
    background: linear-gradient(135deg, #0ea5e9 0%, #0891b2 100%);
}

.cool-equipment-btn.dzs-btn .btn-content h5 {
    font-family: 'Roboto', sans-serif;
    color: #1e40af;
    font-weight: 700;
    font-size: 22px;
    letter-spacing: 2px;
}

.cool-equipment-btn.dzs-btn.active .btn-content h5 {
    color: white;
}

/* Router Buttons */
.cool-equipment-btn.eero-btn {
    border-color: #007bff;
}

.cool-equipment-btn.eero-btn:hover {
    border-color: #007bff;
    box-shadow: 0 8px 25px rgba(0,123,255,0.2);
}

.cool-equipment-btn.eero-btn.active {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
    border-color: #007bff;
    color: white;
}

.cool-equipment-btn.eero-btn .btn-icon {
    background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
}

.cool-equipment-btn.eero-btn .btn-content h5 {
    font-family: 'Open Sans', sans-serif;
    color: #007bff;
    font-weight: 600;
}

.cool-equipment-btn.customer-btn {
    border-color: #6c757d;
}

.cool-equipment-btn.customer-btn:hover {
    border-color: #6c757d;
    box-shadow: 0 8px 25px rgba(108,117,125,0.2);
}

.cool-equipment-btn.customer-btn.active {
    background: linear-gradient(135deg, #6c757d 0%, #565e64 100%);
    border-color: #6c757d;
    color: white;
}

.cool-equipment-btn.customer-btn .btn-icon {
    background: linear-gradient(135deg, #6c757d 0%, #565e64 100%);
}

/* Common styles */
.cool-equipment-btn.active .btn-icon i,
.cool-equipment-btn.active .btn-content span,
.cool-equipment-btn.active .btn-arrow i {
    color: white;
}

.cool-equipment-btn.active .btn-icon {
    background: rgba(255,255,255,0.2);
}

.btn-icon {
    width: 60px;
    height: 60px;
    border-radius: 12px;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 20px;
    flex-shrink: 0;
}

.btn-icon i {
    font-size: 24px;
    color: white;
}

.btn-content {
    flex: 1;
    text-align: left;
}

.btn-content h5 {
    margin: 0 0 4px 0;
    font-weight: 700;
    font-size: 20px;
}

.btn-content span {
    color: #6c757d;
    font-size: 14px;
    font-weight: 500;
}

.btn-arrow {
    margin-left: 16px;
    opacity: 0.6;
    transition: all 0.3s ease;
}

.cool-equipment-btn:hover .btn-arrow {
    opacity: 1;
    transform: translateX(4px);
}

.btn-arrow i {
    font-size: 18px;
    color: inherit;
}
</style>
<div class="container-fluid">
    <!-- Progress Bar -->
    <div class="wizard-progress mb-4">
        <div class="progress-container">
            <div class="step-item {{ 'active' if step == 'ont_selection' else ('completed' if step in ['router_selection', 'issue_selection'] else '') }}" data-step="1">
                <div class="step-circle">
                    <i class="fas fa-search"></i>
                </div>
                <span class="step-label">Identify ONT</span>
            </div>
            <div class="step-connector {{ 'completed' if step in ['router_selection', 'issue_selection'] else '' }}"></div>
            
            <div class="step-item {{ 'active' if step == 'router_selection' else ('completed' if step == 'issue_selection' else '') }}" data-step="2">
                <div class="step-circle">
                    <i class="fas fa-router"></i>
                </div>
                <span class="step-label">Select Router</span>
            </div>
            <div class="step-connector {{ 'completed' if step == 'issue_selection' else '' }}"></div>
            
            <div class="step-item {{ 'active' if step == 'issue_selection' else '' }}" data-step="3">
                <div class="step-circle">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <span class="step-label">Issue Type</span>
            </div>
            <div class="step-connector"></div>
            
            <div class="step-item" data-step="4">
                <div class="step-circle">
                    <i class="fas fa-clipboard-check"></i>
                </div>
                <span class="step-label">Troubleshoot</span>
            </div>
        </div>
    </div>

    <!-- Header with Case Info -->
    <div class="case-header mb-4">
        <h2 class="case-title">
            Case {{ case.case_number }} – In Progress | 
            <span class="step-indicator">{{ step_title }}</span>
        </h2>
    </div>

    <div class="row">
        <!-- Main Content Area -->
        <div class="col-lg-8">
            {% if step == 'ont_selection' %}
            <!-- Step 1: ONT Selection -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Step 1: Select ONT Type
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="Look for the ONT device (small white/black box) usually mounted on the wall where fiber enters the home. Check the label on the device for the type information.">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('troubleshoot_wizard_post', case_id=case.id) }}" id="ontForm">
                        <script>
                        // Store case ID in localStorage
                        localStorage.setItem('tsr_case_id', '{{ case.id }}');
                        localStorage.setItem('tsr_case_timestamp', Date.now());
                        
                        // Check for session expiry and redirect with case ID
                        function checkSession() {
                            if (window.location.search.indexOf('case_id=') === -1) {
                                const caseId = localStorage.getItem('tsr_case_id');
                                if (caseId) {
                                    window.location.href = window.location.pathname + '?case_id=' + caseId;
                                }
                            }
                        }
                        
                        // Run session check periodically
                        setInterval(checkSession, 1000);
                        
                        // If page shows session error, auto-recover
                        window.addEventListener('load', function() {
                            const alerts = document.querySelectorAll('.alert');
                            alerts.forEach(function(alert) {
                                if (alert.textContent.includes('Session') || alert.textContent.includes('expired')) {
                                    window.location.href = '/recover_session';
                                }
                            });
                        });
                        </script>

                        <input type="hidden" name="case_id" value="{{ case.id }}">
                        
                        <div class="mb-4">
                            <label class="form-label required mb-4">Select ONT Type</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn nokia-btn {{ 'active' if case.ont_type == 'Nokia (Altiplano)' else '' }}" data-value="Nokia (Altiplano)" data-target="ont_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-network-wired"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>NOKIA</h5>
                                        <span>Altiplano ONT</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn calix-btn {{ 'active' if case.ont_type == 'Calix (SMX)' else '' }}" data-value="Calix (SMX)" data-target="ont_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-microchip"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>CALIX</h5>
                                        <span>SMX Series</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn dzs-btn {{ 'active' if case.ont_type == 'DZS' else '' }}" data-value="DZS" data-target="ont_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-server"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>DZS</h5>
                                        <span>ONT Device</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="ont_type" id="ont_type_input" value="{{ case.ont_type or '' }}" required>
                        </div>

                        <div class="wizard-actions mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('index') }}'">
                                <i class="fas fa-home me-2"></i>
                                Back to Home
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% elif step == 'router_selection' %}
            <!-- Step 2: Router Selection -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-router me-2"></i>
                        Step 2: Select Router Type
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="The router is usually a separate device connected to the ONT. For Eero systems, look for mesh units throughout the home. Check device labels for model information.">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('troubleshoot_wizard_post', case_id=case.id) }}" id="routerForm">
                        
                        <div class="mb-4">
                            <label class="form-label required mb-4">Select Router Type</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn eero-btn {{ 'active' if case.router_type == 'Eero' else '' }}" data-value="Eero" data-target="router_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-wifi"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>eero</h5>
                                        <span>eero System</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn nokia-btn {{ 'active' if case.router_type == 'Nokia' else '' }}" data-value="Nokia" data-target="router_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-router"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>NOKIA</h5>
                                        <span>Router Device</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn customer-btn {{ 'active' if case.router_type == 'Customer-Owned' else '' }}" data-value="Customer-Owned" data-target="router_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-user-cog"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Customer</h5>
                                        <span>Own Router</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="router_type" id="router_type_input" value="{{ case.router_type or '' }}" required>
                        </div>

                        <div class="wizard-actions mt-4">
                            <button type="button" class="btn btn-outline-secondary" onclick="window.location.href='{{ url_for('troubleshoot_wizard_step', step=1, case_id=case.id) }}'">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to ONT Selection
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% elif step == 'issue_selection' %}
            <!-- Step 3: Issue Type Selection -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Step 3: Select Issue Type
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="Select the primary issue the customer is reporting to determine the correct troubleshooting path.">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('troubleshoot_wizard_post', case_id=case.id) }}" id="issueForm">
                        
                        <div class="mb-4">
                            <label class="form-label required">What is the customer reporting?</label>
                            <div class="issue-options">
                                <div class="form-check issue-card mb-3">
                                    <input class="form-check-input" type="radio" name="issue_type" id="harddown" value="No Internet" required>
                                    <label class="form-check-label" for="harddown">
                                        <div class="issue-content">
                                            <h6><i class="fas fa-times-circle text-danger me-2"></i>No Internet (Hard Down)</h6>
                                            <p class="small text-muted mb-0">Customer has no internet connectivity at all</p>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check issue-card mb-3">
                                    <input class="form-check-input" type="radio" name="issue_type" id="slow" value="Slow Speeds" required>
                                    <label class="form-check-label" for="slow">
                                        <div class="issue-content">
                                            <h6><i class="fas fa-tachometer-alt text-warning me-2"></i>Slow Speeds</h6>
                                            <p class="small text-muted mb-0">Internet is working but slower than expected</p>
                                        </div>
                                    </label>
                                </div>
                                <div class="form-check issue-card mb-3">
                                    <input class="form-check-input" type="radio" name="issue_type" id="intermittent" value="Intermittent Connection" required>
                                    <label class="form-check-label" for="intermittent">
                                        <div class="issue-content">
                                            <h6><i class="fas fa-wifi text-info me-2"></i>Intermittent Connection</h6>
                                            <p class="small text-muted mb-0">Connection drops out or is unstable</p>
                                        </div>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <label for="issue_description" class="form-label">Additional Details</label>
                            <textarea class="form-control" id="issue_description" name="issue_description" rows="3" 
                                      placeholder="Any additional details about the customer's issue..."></textarea>
                        </div>

                        <div class="wizard-actions mt-4">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="window.location.href='{{ url_for('troubleshoot_wizard_step', step=2, case_id=case.id) }}'">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Router Selection
                            </button>
                            <button type="submit" class="btn btn-primary btn-lg" id="continueBtn" disabled>
                                <i class="fas fa-arrow-right me-2"></i>
                                Begin Troubleshooting
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% elif step == 'fiber_precheck' %}
            <!-- Step 4: Fiber Pre-Check -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-search-plus me-2"></i>
                        Fiber Pre-Check
                        <button type="button" class="btn btn-link p-0 ms-2" data-bs-toggle="tooltip" 
                                title="Perform initial fiber diagnostics before detailed troubleshooting">
                            <i class="fas fa-info-circle text-muted"></i>
                        </button>
                    </h4>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('troubleshoot_wizard_post', case_id=case.id) }}" id="preCheckForm">
                        
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Pull alarms from Altiplano → ONT > Alarms tab → Click "+ Add Alarm" for each Active/Cleared entry.</strong>
                            <br><small>Streamlined fiber diagnostics using authentic Altiplano data with repeatable alarm entry system.</small>
                        </div>

                        <div class="mb-4">
                            <label class="form-label required">Alarm 1 - Status</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn {{ 'active' if 'alarm1_status' in session and session.alarm1_status == 'Active' else '' }}" data-value="Active" data-target="alarm1_status">
                                    <div class="btn-icon">
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Active</h5>
                                        <span>Current alarm</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn {{ 'active' if 'alarm1_status' in session and session.alarm1_status == 'Cleared' else '' }}" data-value="Cleared" data-target="alarm1_status">
                                    <div class="btn-icon">
                                        <i class="fas fa-check-circle text-success"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Cleared</h5>
                                        <span>Resolved alarm</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn {{ 'active' if 'alarm1_status' in session and session.alarm1_status == 'No Alarms' else '' }}" data-value="No Alarms" data-target="alarm1_status">
                                    <div class="btn-icon">
                                        <i class="fas fa-shield-alt text-primary"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>No Alarms</h5>
                                        <span>Clean status</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="alarm1_status" id="alarm1_status_input" value="" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label required">Alarm 1 - Type</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn" data-value="ONU Loss of PHY Layer" data-target="alarm1_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-unlink"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>ONU Loss of PHY Layer</h5>
                                        <span>Physical connection lost</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Loss of Signal (LOS)" data-target="alarm1_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-signal-slash"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Loss of Signal (LOS)</h5>
                                        <span>No signal detected</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Other/Custom" data-target="alarm1_type">
                                    <div class="btn-icon">
                                        <i class="fas fa-question-circle"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Other/Custom</h5>
                                        <span>Specify in notes</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="alarm1_type" id="alarm1_type_input" value="" required>
                        </div>

                        <div class="mb-4">
                            <label for="alarm1_notes" class="form-label">Alarm 1 - Notes (Optional)</label>
                            <textarea class="form-control" id="alarm1_notes" name="alarm1_notes" rows="2" 
                                      placeholder="e.g. Cleared after splice, timestamp from Altiplano"></textarea>
                        </div>

                        <div class="mb-4">
                            <label for="additional_alarms" class="form-label">Additional Alarms</label>
                            <textarea class="form-control" id="additional_alarms" name="additional_alarms" rows="3" 
                                      placeholder="If more alarms exist, list them here with Status, Type, and any notes..."></textarea>
                        </div>

                        <div class="mb-4">
                            <label class="form-label required">ONT RX Power (dBm)</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn" data-value="-10 to -25" data-target="ont_rx_power">
                                    <div class="btn-icon">
                                        <i class="fas fa-signal text-success"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Normal Range</h5>
                                        <span>-10 to -25</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Outside Range" data-target="ont_rx_power">
                                    <div class="btn-icon">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Outside Range</h5>
                                        <span>Specify in notes</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="ont_rx_power" id="ont_rx_power_input" value="" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label required">OLT TX Power (dBm)</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn" data-value="-10 to -25 (gap ≤4)" data-target="olt_tx_power">
                                    <div class="btn-icon">
                                        <i class="fas fa-signal text-success"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Normal Range</h5>
                                        <span>-10 to -25 (gap ≤4)</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Gap >4 or Outside Range" data-target="olt_tx_power">
                                    <div class="btn-icon">
                                        <i class="fas fa-exclamation-triangle text-warning"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Gap >4 or Outside Range</h5>
                                        <span>Specify in notes</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="olt_tx_power" id="olt_tx_power_input" value="" required>
                        </div>

                        <div class="mb-4">
                            <label class="form-label required">Light Levels (if available)</label>
                            <div class="cool-button-grid">
                                <button type="button" class="cool-equipment-btn" data-value="Good Light Levels (-20 to -10)" data-target="light_levels">
                                    <div class="btn-icon">
                                        <i class="fas fa-signal text-success"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Good Light Levels</h5>
                                        <span>-20 to -10</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Low Light Levels (-25 or lower)" data-target="light_levels">
                                    <div class="btn-icon">
                                        <i class="fas fa-signal text-warning"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Low Light Levels</h5>
                                        <span>-25 or lower</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Gap Too Wide (more than 5 points apart)" data-target="light_levels">
                                    <div class="btn-icon">
                                        <i class="fas fa-exclamation-triangle text-danger"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Gap Too Wide</h5>
                                        <span>More than 5 points apart</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                                
                                <button type="button" class="cool-equipment-btn" data-value="Cannot Access Light Levels" data-target="light_levels">
                                    <div class="btn-icon">
                                        <i class="fas fa-question-circle text-secondary"></i>
                                    </div>
                                    <div class="btn-content">
                                        <h5>Cannot Access Light Levels</h5>
                                        <span>Unable to check</span>
                                    </div>
                                    <div class="btn-arrow">
                                        <i class="fas fa-chevron-right"></i>
                                    </div>
                                </button>
                            </div>
                            <input type="hidden" name="light_levels" id="light_levels_input" value="">
                        </div>

                        <div class="mb-4">
                            <label for="precheck_notes" class="form-label">Additional Notes</label>
                            <textarea class="form-control" id="precheck_notes" name="precheck_notes" rows="3" 
                                      placeholder="Any additional observations, specific power levels, or other details..."></textarea>
                        </div>

                        <div class="wizard-actions mt-4">
                            <button type="button" class="btn btn-outline-secondary me-2" onclick="window.history.back()">
                                <i class="fas fa-arrow-left me-2"></i>
                                Back to Issue Type
                            </button>
                            <button type="submit" class="btn btn-primary" name="complete_precheck" value="true">
                                <i class="fas fa-arrow-right me-2"></i>
                                Begin Troubleshooting
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            {% else %}
            <!-- Step 5: Log & Report -->
            <div class="wizard-card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-clipboard-check me-2"></i>
                        Case Summary & Report
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Final report content -->
                    <div class="summary-report">
                        <p>Case summary and dispatch information will be generated here.</p>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Side Panel -->
        <div class="col-lg-4">
            <div class="side-panel">
                <!-- Equipment Information -->
                <div class="info-card">
                    <div class="card-header collapsible" data-bs-toggle="collapse" data-bs-target="#equipmentInfo">
                        <h6 class="mb-0">
                            <i class="fas fa-cogs me-2"></i>
                            Equipment Information
                            <i class="fas fa-chevron-down float-end"></i>
                        </h6>
                    </div>
                    <div class="collapse show" id="equipmentInfo">
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <span class="info-label">ONT Type:</span>
                                    <span class="info-value status-badge {{ 'badge-success' if case.ont_type else 'badge-neutral' }}">
                                        {{ case.ont_type or 'Not selected' }}
                                    </span>
                                </div>
                                <div class="info-item">
                                    <span class="info-label">Router Type:</span>
                                    <span class="info-value status-badge {{ 'badge-success' if case.router_type else 'badge-neutral' }}">
                                        {{ case.router_type or 'Not selected' }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sticky Footer -->
    <div class="sticky-footer">
        <div class="footer-content">
            <div class="footer-left">
                <span class="text-muted small">
                    <i class="fas fa-save me-1"></i>
                    Auto-saved
                </span>
            </div>
            <div class="footer-right">
                <a href="{{ url_for('case_summary', case_id=case.id) }}" class="btn btn-outline-primary btn-sm me-2">
                    <i class="fas fa-eye me-1"></i>
                    View Summary
                </a>
                <a href="{{ url_for('index') }}" class="btn btn-outline-secondary btn-sm">
                    <i class="fas fa-home me-1"></i>
                    Back to Home
                </a>
            </div>
        </div>
    </div>
</div>

<script>
// Cool button functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle cool equipment button clicks - submit immediately
    document.querySelectorAll('.cool-equipment-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const value = this.dataset.value;
            const target = this.dataset.target;
            
            // Update hidden input
            const hiddenInput = document.getElementById(target + '_input');
            if (hiddenInput) {
                hiddenInput.value = value;
            }
            
            // Submit immediately without animations
            const form = this.closest('form');
            if (form) {
                form.submit();
            }
        });
    });

    // Form validation and navigation
    const forms = document.querySelectorAll('form');
    
    forms.forEach(form => {
        const requiredFields = form.querySelectorAll('[required]');
        const submitBtn = form.querySelector('#continueBtn');
        
        if (requiredFields.length > 0 && submitBtn) {
            function validateForm() {
                let isValid = true;
                requiredFields.forEach(field => {
                    if (!field.value.trim()) {
                        isValid = false;
                    }
                });
                submitBtn.disabled = !isValid;
            }
            
            requiredFields.forEach(field => {
                field.addEventListener('input', validateForm);
                field.addEventListener('change', validateForm);
            });
            
            validateForm(); // Initial check
        }
    });
    
    // Router type specific logic
    const routerTypeSelect = document.getElementById('router_type');
    const routerIdContainer = document.getElementById('routerIdContainer');
    
    if (routerTypeSelect) {
        routerTypeSelect.addEventListener('change', function() {
            if (this.value && this.value !== 'Customer-Owned') {
                routerIdContainer.style.display = 'block';
            } else {
                routerIdContainer.style.display = 'none';
            }
        });
        
        // Trigger on load
        if (routerTypeSelect.value && routerTypeSelect.value !== 'Customer-Owned') {
            routerIdContainer.style.display = 'block';
        }
    }
    
    // Auto-focus first empty field
    const firstEmptyField = document.querySelector('select:not([value]), input:not([value])');
    if (firstEmptyField) {
        firstEmptyField.focus();
    }
});

function previousStep() {
    window.history.back();
}

function nextStep() {
    // Handle next step navigation
    const form = document.querySelector('form');
    if (form) {
        form.submit();
    }
}

// Step navigation
document.querySelectorAll('.step-item.completed').forEach(step => {
    step.style.cursor = 'pointer';
    step.addEventListener('click', function() {
        const stepNum = this.dataset.step;
        // Navigate to specific step (implement as needed)
        console.log('Navigate to step:', stepNum);
    });
});
</script>
{% endblock %}