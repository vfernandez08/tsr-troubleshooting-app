{% extends "base.html" %}

{% block title %}Troubleshooting Case {{ case.case_number }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Content -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-tools me-2"></i>
                        Case {{ case.case_number }} - {{ case.status|title }}
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Progress Bar -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-bold">Progress</span>
                            <span class="text-muted">Step {{ step_number }}</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar" role="progressbar" 
                                 style="width: {{ progress_percentage }}%"></div>
                        </div>
                    </div>

                    <!-- Current Step -->
                    <div class="mb-4">
                        <h5 class="text-primary mb-3">{{ current_step.question|markdown|safe }}</h5>
                        
                        {% if current_step.description %}
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            {{ current_step.description }}
                        </div>
                        {% endif %}

                        <!-- Input Fields -->
                        {% if current_step.input_fields %}
                        <form method="POST" action="{{ url_for('next_step') }}" class="mb-4">
                            {% for field in current_step.input_fields %}
                            <div class="mb-3">
                                <label for="{{ field.name }}" class="form-label fw-bold">
                                    {{ field.label }}
                                    {% if field.required %}<span class="text-danger">*</span>{% endif %}
                                </label>
                                
                                {% if field.type == 'select' %}
                                <select class="form-select" id="{{ field.name }}" name="{{ field.name }}" 
                                        {% if field.required %}required{% endif %}>
                                    <option value="">Select {{ field.label }}</option>
                                    {% for option in field.options %}
                                    <option value="{{ option.value }}">{{ option.label }}</option>
                                    {% endfor %}
                                </select>
                                {% else %}
                                <input type="{{ field.type }}" class="form-control" 
                                       id="{{ field.name }}" name="{{ field.name }}"
                                       placeholder="{{ field.placeholder or '' }}"
                                       {% if field.required %}required{% endif %}>
                                {% endif %}
                            </div>
                            {% endfor %}
                            
                            <input type="hidden" name="case_id" value="{{ case.id }}">
                            <input type="hidden" name="step_id" value="{{ current_step_id }}">
                            <input type="hidden" name="action_taken" value="Form submitted">
                        </form>
                        {% endif %}

                        <!-- Action Options -->
                        {% if current_step.options %}
                        <form method="POST" action="{{ url_for('next_step') }}">
                            <div class="row">
                                {% for option, next_step in current_step.options.items() %}
                                <div class="col-md-6 mb-3">
                                    <button type="submit" name="next_step" value="{{ next_step }}" 
                                            class="btn btn-outline-primary w-100 h-100 p-3"
                                            onclick="document.querySelector('input[name=action_taken]').value='{{ option }}'">
                                        <div class="mb-2">
                                            <i class="fas fa-arrow-right text-primary" style="font-size: 24px;"></i>
                                        </div>
                                        <div>
                                            <strong>{{ option }}</strong>
                                            <br><small class="text-muted">Click to continue</small>
                                        </div>
                                    </button>
                                </div>
                                {% endfor %}
                            </div>
                            
                            <input type="hidden" name="case_id" value="{{ case.id }}">
                            <input type="hidden" name="step_id" value="{{ current_step_id }}">
                            <input type="hidden" name="action_taken" value="">
                        </form>
                        {% endif %}

                        <!-- Help Text -->
                        {% if current_step.help_text %}
                        <div class="alert alert-light border">
                            <i class="fas fa-lightbulb me-2 text-warning"></i>
                            <strong>Tip:</strong> {{ current_step.help_text }}
                        </div>
                        {% endif %}

                        <!-- Notes Section -->
                        <div class="mt-4">
                            <form method="POST" action="{{ url_for('add_note') }}" class="d-flex gap-2">
                                <input type="text" class="form-control" name="note" 
                                       placeholder="Add a note about this step...">
                                <input type="hidden" name="case_id" value="{{ case.id }}">
                                <input type="hidden" name="step_id" value="{{ current_step_id }}">
                                <button type="submit" class="btn btn-outline-secondary">
                                    <i class="fas fa-plus"></i>
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Customer Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Customer Information</h6>
                </div>
                <div class="card-body">
                    {% set customer = case.get_customer_info() %}
                    <p><strong>Name:</strong> {{ customer.name or 'N/A' }}</p>
                    <p><strong>Account:</strong> {{ customer.account or 'N/A' }}</p>
                    <p><strong>Phone:</strong> {{ customer.phone or 'N/A' }}</p>
                    <p><strong>Email:</strong> {{ customer.email or 'N/A' }}</p>
                </div>
            </div>

            <!-- Equipment Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Equipment Information</h6>
                </div>
                <div class="card-body">
                    <p><strong>ONT Type:</strong> {{ case.ont_type or 'Not selected' }}</p>
                    <p><strong>ONT ID:</strong> {{ case.ont_id or 'Not entered' }}</p>
                    <p><strong>Router Type:</strong> {{ case.router_type or 'Not selected' }}</p>
                    <p><strong>Router ID:</strong> {{ case.router_id or 'Not entered' }}</p>
                    <p><strong>Issue Type:</strong> {{ case.issue_type or 'Not identified' }}</p>
                </div>
            </div>

            <!-- Step History -->
            {% if step_history %}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h6 class="mb-0">Step History</h6>
                </div>
                <div class="card-body">
                    {% for step in step_history %}
                    <div class="border-bottom pb-2 mb-2">
                        <small class="text-muted">{{ step.timestamp.strftime('%H:%M:%S') }}</small>
                        <p class="mb-1"><strong>{{ step.step_name }}</strong></p>
                        {% if step.action_taken %}
                        <p class="mb-1"><small>Action: {{ step.action_taken }}</small></p>
                        {% endif %}
                        {% if step.notes %}
                        <p class="mb-0"><small class="text-muted">Note: {{ step.notes }}</small></p>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Actions -->
            <div class="card shadow-sm">
                <div class="card-header">
                    <h6 class="mb-0">Actions</h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <form method="POST" action="{{ url_for('go_back') }}">
                            <input type="hidden" name="case_id" value="{{ case.id }}">
                            <button type="submit" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-arrow-left me-2"></i>Go Back
                            </button>
                        </form>
                        
                        <form method="POST" action="{{ url_for('restart_case') }}">
                            <input type="hidden" name="case_id" value="{{ case.id }}">
                            <button type="submit" class="btn btn-outline-warning w-100">
                                <i class="fas fa-redo me-2"></i>Restart Case
                            </button>
                        </form>
                        
                        <a href="{{ url_for('case_summary', case_id=case.id) }}" class="btn btn-outline-info w-100">
                            <i class="fas fa-eye me-2"></i>View Summary
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
function setActionTaken(action) {
    const input = document.querySelector('input[name="action_taken"]');
    if (input) {
        input.value = action;
    }
}
</script>
{% endblock %}